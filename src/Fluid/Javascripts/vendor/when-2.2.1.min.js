/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 * @version 2.2.1
 */
(function(e,t){"use strict";e(function(){function e(e,t,n,i){return r(e).then(t,n,i)}function n(e,t){this.then=e;this.inspect=t}function r(e){return o(function(t){t(e)})}function i(t){return e(t,l)}function s(){function i(i,s,o){e.resolve=e.resolver.resolve=function(e){if(n){return r(e)}n=true;i(e);return t};e.reject=e.resolver.reject=function(e){if(n){return r(l(e))}n=true;s(e);return t};e.notify=e.resolver.notify=function(e){o(e);return e}}var e,t,n;e={promise:H,resolve:H,reject:H,notify:H,resolver:{resolve:H,reject:H,notify:H}};e.promise=t=o(i);return e}function o(e){return u(e,P.PromiseStatus&&P.PromiseStatus())}function u(e,t){function f(e,n,r){var o=u(function(t,o,u){function a(i){i.then(e,n,r).then(t,o,u)}s?s.push(a):B(function(){a(i)})},t&&t.observed());return o}function p(){return i?i.inspect():T()}function d(e){if(!s){return}i=a(e);h(s,i);s=H;if(t){i.then(function(){t.fulfilled()},function(e){t.rejected(e)})}}function v(e){d(l(e))}function m(e){if(s){h(s,c(e))}}var r,i,s=[];r=new n(f,p);try{e(d,v,m)}catch(o){v(o)}return r}function a(e){if(e instanceof n){return e}if(!(e===Object(e)&&"then"in e)){return f(e)}return o(function(t,n,r){B(function(){try{var i=e.then;if(typeof i==="function"){k(i,e,t,n,r)}else{t(f(e))}}catch(s){n(s)}})})}function f(e){var t=new n(function(n){try{return typeof n=="function"?a(n(e)):t}catch(r){return l(r)}},function(){return S(e)});return t}function l(e){var t=new n(function(n,r){try{return typeof r=="function"?a(r(e)):t}catch(i){return l(i)}},function(){return x(e)});return t}function c(e){var t=new n(function(n,r,i){try{return typeof i=="function"?c(i(e)):t}catch(s){return c(s)}});return t}function h(e,t){B(function(){var n,r=0;while(n=e[r++]){n(t)}})}function p(e){return e&&typeof e.then==="function"}function d(t,n,r,i,s){return e(t,function(t){function u(r,i,s){function d(e){c(e)}function v(e){l(e)}var o,u,a,f,l,c,h,p;h=t.length>>>0;o=Math.max(0,Math.min(n,h));a=[];u=h-o+1;f=[];if(!o){r(a)}else{c=function(e){f.push(e);if(!--u){l=c=F;i(f)}};l=function(e){a.push(e);if(!--o){l=c=F;r(a)}};for(p=0;p<h;++p){if(p in t){e(t[p],v,d,s)}}}}return o(u).then(r,i,s)})}function v(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return d(e,1,i,n,r)}function m(e,t,n,r){return w(e,F).then(t,n,r)}function g(){return w(arguments,F)}function y(e){return w(e,S,x)}function b(e,t){return w(e,t)}function w(t,n,r){return e(t,function(t){function i(i,s,o){function c(t,a){e(t,n,r).then(function(e){u[a]=e;if(!--f){i(u)}},s,o)}var u,a,f,l;f=a=t.length>>>0;u=[];if(!f){i(u);return}for(l=0;l<a;l++){if(l in t){c(t[l],l)}else{--f}}}return o(i)})}function E(t,n){var r=k(C,arguments,1);return e(t,function(t){var i;i=t.length;r[0]=function(t,r,s){return e(t,function(t){return e(r,function(e){return n(t,e,s,i)})})};return N.apply(t,r)})}function S(e){return{state:"fulfilled",value:e}}function x(e){return{state:"rejected",reason:e}}function T(){return{state:"pending"}}function B(e){if(A.push(e)===1){L(j)}}function j(){var e,t=0;while(e=A[t++]){e()}A=[]}function F(e){return e}e.promise=o;e.resolve=r;e.reject=i;e.defer=s;e.join=g;e.all=m;e.map=b;e.reduce=E;e.settle=y;e.any=v;e.some=d;e.isPromise=p;n.prototype={otherwise:function(e){return this.then(H,e)},ensure:function(e){function t(){return r(e())}return this.then(t,t)["yield"](this)},yield:function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return m(t,function(t){return e.apply(H,t)})})},always:function(e,t){return this.then(e,e,t)}};var N,C,k,L,A,O,M,_,D,P,H;A=[];P=typeof console!="undefined"?console:e;O=t.setTimeout;L=typeof setImmediate==="function"?setImmediate.bind(t):typeof process==="object"&&process.nextTick?process.nextTick:typeof vertx==="object"?vertx.runOnLoop:function(e){O(e,0)};M=Function.prototype;_=M.call;k=M.bind?_.bind(_):function(e,t){return e.apply(t,C.call(arguments,2))};D=[];C=D.slice;N=D.reduce||function(e){var t,n,r,i,s;s=0;t=Object(this);i=t.length>>>0;n=arguments;if(n.length<=1){for(;;){if(s in t){r=t[s++];break}if(++s>=i){throw new TypeError}}}else{r=n[1]}for(;s<i;++s){if(s in t){r=e(r,t[s],s,t)}}return r};return e})})(typeof define==="function"&&define.amd?define:function(e){module.exports=e()},this)