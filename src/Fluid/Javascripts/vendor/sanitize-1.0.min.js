/**
 * Copyright (c) 2010 by Gabriel Birke
 *
 * @version 1.0
 */
function Sanitize(){var e,t,n;n=arguments[0]||{};this.config={};this.config.elements=n.elements?n.elements:[];this.config.attributes=n.attributes?n.attributes:{};this.config.attributes[Sanitize.ALL]=this.config.attributes[Sanitize.ALL]?this.config.attributes[Sanitize.ALL]:[];this.config.allow_comments=n.allow_comments?n.allow_comments:false;this.allowed_elements={};this.config.protocols=n.protocols?n.protocols:{};this.config.add_attributes=n.add_attributes?n.add_attributes:{};this.dom=n.dom?n.dom:document;for(e=0;e<this.config.elements.length;e++){this.allowed_elements[this.config.elements[e]]=true}this.config.remove_element_contents={};this.config.remove_all_contents=false;if(n.remove_contents){if(n.remove_contents instanceof Array){for(e=0;e<n.remove_contents.length;e++){this.config.remove_element_contents[n.remove_contents[e]]=true}}else{this.config.remove_all_contents=true}}this.transformers=n.transformers?n.transformers:[]}Sanitize.REGEX_PROTOCOL=/^([A-Za-z0-9\+\-\.\&\;\*\s]*?)(?:\:|&*0*58|&*x0*3a)/i;Sanitize.RELATIVE="__relative__";Sanitize.prototype.clean_node=function(e){function n(e,t){var n;for(n=0;n<t.length;n++){if(t[n]==e)return n}return-1}function r(){var e=[];var t={};var n,r;for(n=0;n<arguments.length;n++){if(!arguments[n]||!arguments[n].length)continue;for(r=0;r<arguments[n].length;r++){if(t[arguments[n][r]])continue;t[arguments[n][r]]=true;e.push(arguments[n][r])}}return e}function s(e){var t;switch(e.nodeType){case 1:o.call(this,e);break;case 3:t=e.cloneNode(false);this.current_element.appendChild(t);break;case 5:t=e.cloneNode(false);this.current_element.appendChild(t);break;case 8:if(this.config.allow_comments){t=e.cloneNode(false);this.current_element.appendChild(t)}break;default:if(console&&console.log)console.log("unknown node type",e.nodeType);break}}function o(e){var t,i,o,a,f,l,c,h,p,d,v,m;var g=u.call(this,e);e=g.node;f=e.nodeName.toLowerCase();a=this.current_element;if(this.allowed_elements[f]||g.whitelist){this.current_element=this.dom.createElement(e.nodeName);a.appendChild(this.current_element);var y=this.config.attributes;l=r(y[f],y["__ALL__"],g.attr_whitelist);for(t=0;t<l.length;t++){h=l[t];c=e.attributes[h];if(c){m=true;if(this.config.protocols[f]&&this.config.protocols[f][h]){d=this.config.protocols[f][h];v=c.nodeValue.toLowerCase().match(Sanitize.REGEX_PROTOCOL);if(v){m=n(v[1],d)!=-1}else{m=n(Sanitize.RELATIVE,d)!=-1}}if(m){p=document.createAttribute(h);p.value=c.nodeValue;this.current_element.setAttributeNode(p)}}}if(this.config.add_attributes[f]){for(h in this.config.add_attributes[f]){p=document.createAttribute(h);p.value=this.config.add_attributes[f][h];this.current_element.setAttributeNode(p)}}}else if(n(e,this.whitelist_nodes)!=-1){this.current_element=e.cloneNode(true);while(this.current_element.childNodes.length>0){this.current_element.removeChild(this.current_element.firstChild)}a.appendChild(this.current_element)}if(!this.config.remove_all_contents&&!this.config.remove_element_contents[f]){for(t=0;t<e.childNodes.length;t++){s.call(this,e.childNodes[t])}}if(this.current_element.normalize){this.current_element.normalize()}this.current_element=a}function u(e){var t={attr_whitelist:[],node:e,whitelist:false};var i,s,o;for(i=0;i<this.transformers.length;i++){o=this.transformers[i]({allowed_elements:this.allowed_elements,config:this.config,node:e,node_name:e.nodeName.toLowerCase(),whitelist_nodes:this.whitelist_nodes,dom:this.dom});if(o==null)continue;else if(typeof o=="object"){if(o.whitelist_nodes&&o.whitelist_nodes instanceof Array){for(s=0;s<o.whitelist_nodes.length;s++){if(n(o.whitelist_nodes[s],this.whitelist_nodes)==-1){this.whitelist_nodes.push(o.whitelist_nodes[s])}}}t.whitelist=o.whitelist?true:false;if(o.attr_whitelist){t.attr_whitelist=r(t.attr_whitelist,o.attr_whitelist)}t.node=o.node?o.node:t.node}else{throw new Error("transformer output must be an object or null")}}return t}var t=this.dom.createDocumentFragment();this.current_element=t;this.whitelist_nodes=[];for(i=0;i<e.childNodes.length;i++){s.call(this,e.childNodes[i])}if(t.normalize){t.normalize()}return t};if(typeof define==="function"){define("sanitize",[],function(){return Sanitize})}