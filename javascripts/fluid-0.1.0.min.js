require(['bootstrap'], function () {
    window.location.rootpath = window.location.pathname;

    require([
        'backbone',
        'marionette',
        'ejs',
        'lib/helpers',
        'models/session/session',
        'models/user/user',
        'controllers/fluid'
    ], function (Backbone, Marionette, EJS, Helpers, Session, User, FluidController) {
        Backbone.Marionette.Renderer.render = function(template, data) {
            return template.render(data);
        };

        var FluidApp = new Marionette.Application();

        FluidApp.addRegions({
            mainRegion: "#main",
            websiteRegion: '#target'
        });

        FluidApp.addInitializer(function(options) {
            FluidApp.params = {
                branch: initParams.branch,
                path: initParams.path,
                websocket: initParams.websocket
            };
            var session = new Session({token: readCookie('fluid_session')});
            var user = new User(initParams.user);
            new FluidController({
                app: FluidApp,
                user: user,
                session: session
            });
        });

        FluidApp.addInitializer(function(options){
            Backbone.history.start({pushState: true});

            Backbone.history.navigate('/');
            // Block delete button from navigating
            $(document).keydown(function (e) {
                if (e.keyCode == 8) {
                    if (
                        (document.activeElement.getAttribute('contenteditable') !== "true") &&
                            (document.activeElement.tagName !== "INPUT")
                        ) {
                        return false;
                    }
                }
                return true;
            });
        });

        FluidApp.start();
    });
});