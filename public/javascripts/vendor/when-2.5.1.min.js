!function(define,global){"use strict";define(function(require){function when(promiseOrValue,onFulfilled,onRejected,onProgress){return cast(promiseOrValue).then(onFulfilled,onRejected,onProgress)}function cast(x){return x instanceof Promise?x:resolve(x)}function Promise(sendMessage,inspect){this._message=sendMessage,this.inspect=inspect}function resolve(value){return promise(function(resolve){resolve(value)})}function reject(promiseOrValue){return when(promiseOrValue,rejected)}function defer(){function makeDeferred(resolvePending,rejectPending,notifyPending){deferred.resolve=deferred.resolver.resolve=function(value){return resolved?resolve(value):(resolved=!0,resolvePending(value),pending)},deferred.reject=deferred.resolver.reject=function(reason){return resolved?resolve(rejected(reason)):(resolved=!0,rejectPending(reason),pending)},deferred.notify=deferred.resolver.notify=function(update){return notifyPending(update),update}}var deferred,pending,resolved;return deferred={promise:undef,resolve:undef,reject:undef,notify:undef,resolver:{resolve:undef,reject:undef,notify:undef}},deferred.promise=pending=promise(makeDeferred),deferred}function promise(resolver){return _promise(resolver,monitorApi.PromiseStatus&&monitorApi.PromiseStatus())}function _promise(resolver,status){function _message(type,args,resolve,notify){function deliver(p){p._message(type,args,resolve,notify)}consumers?consumers.push(deliver):enqueue(function(){deliver(value)})}function inspect(){return value?value.inspect():toPendingState()}function promiseResolve(val){if(consumers){var queue=consumers;consumers=undef,enqueue(function(){value=coerce(self,val),status&&updateStatus(value,status),runHandlers(queue,value)})}}function promiseReject(reason){promiseResolve(rejected(reason))}function promiseNotify(update){if(consumers){var queue=consumers;enqueue(function(){runHandlers(queue,progressed(update))})}}var self,value,consumers=[];self=new Promise(_message,inspect),self._status=status;try{resolver(promiseResolve,promiseReject,promiseNotify)}catch(e){promiseReject(e)}return self}function runHandlers(queue,value){for(var i=0;i<queue.length;i++)queue[i](value)}function fulfilled(value){return near(new NearFulfilledProxy(value),function(){return toFulfilledState(value)})}function rejected(reason){return near(new NearRejectedProxy(reason),function(){return toRejectedState(reason)})}function near(proxy,inspect){return new Promise(function(type,args,resolve){try{resolve(proxy[type].apply(proxy,args))}catch(e){resolve(rejected(e))}},inspect)}function progressed(update){return new Promise(function(type,args,_,notify){var onProgress=args[2];try{notify("function"==typeof onProgress?onProgress(update):update)}catch(e){notify(e)}})}function coerce(self,x){if(x===self)return rejected(new TypeError);if(x instanceof Promise)return x;try{var untrustedThen=x===Object(x)&&x.then;return"function"==typeof untrustedThen?assimilate(untrustedThen,x):fulfilled(x)}catch(e){return rejected(e)}}function assimilate(untrustedThen,x){return promise(function(resolve,reject){fcall(untrustedThen,x,resolve,reject)})}function NearFulfilledProxy(value){this.value=value}function NearRejectedProxy(reason){this.reason=reason}function updateStatus(value,status){function statusFulfilled(){status.fulfilled()}function statusRejected(r){status.rejected(r)}value.then(statusFulfilled,statusRejected)}function isPromiseLike(x){return x&&"function"==typeof x.then}function some(promisesOrValues,howMany,onFulfilled,onRejected,onProgress){return when(promisesOrValues,function(promisesOrValues){function resolveSome(resolve,reject,notify){function rejecter(reason){rejectOne(reason)}function fulfiller(val){fulfillOne(val)}var toResolve,toReject,values,reasons,fulfillOne,rejectOne,len,i;if(len=promisesOrValues.length>>>0,toResolve=Math.max(0,Math.min(howMany,len)),values=[],toReject=len-toResolve+1,reasons=[],toResolve)for(rejectOne=function(reason){reasons.push(reason),--toReject||(fulfillOne=rejectOne=identity,reject(reasons))},fulfillOne=function(val){values.push(val),--toResolve||(fulfillOne=rejectOne=identity,resolve(values))},i=0;len>i;++i)i in promisesOrValues&&when(promisesOrValues[i],fulfiller,rejecter,notify);else resolve(values)}return promise(resolveSome).then(onFulfilled,onRejected,onProgress)})}function any(promisesOrValues,onFulfilled,onRejected,onProgress){function unwrapSingleResult(val){return onFulfilled?onFulfilled(val[0]):val[0]}return some(promisesOrValues,1,unwrapSingleResult,onRejected,onProgress)}function all(promisesOrValues,onFulfilled,onRejected,onProgress){return _map(promisesOrValues,identity).then(onFulfilled,onRejected,onProgress)}function join(){return _map(arguments,identity)}function settle(array){return _map(array,toFulfilledState,toRejectedState)}function map(array,mapFunc){return _map(array,mapFunc)}function _map(array,mapFunc,fallback){return when(array,function(array){function resolveMap(resolve,reject,notify){function resolveOne(item,i){when(item,mapFunc,fallback).then(function(mapped){results[i]=mapped,--toResolve||resolve(results)},reject,notify)}var results,len,toResolve,i;if(toResolve=len=array.length>>>0,results=[],!toResolve)return resolve(results),void 0;for(i=0;len>i;i++)i in array?resolveOne(array[i],i):--toResolve}return _promise(resolveMap)})}function reduce(promise,reduceFunc){var args=fcall(slice,arguments,1);return when(promise,function(array){var total;return total=array.length,args[0]=function(current,val,i){return when(current,function(c){return when(val,function(value){return reduceFunc(c,value,i,total)})})},reduceArray.apply(array,args)})}function toFulfilledState(x){return{state:"fulfilled",value:x}}function toRejectedState(x){return{state:"rejected",reason:x}}function toPendingState(){return{state:"pending"}}function enqueue(task){1===handlerQueue.push(task)&&nextTick(drainQueue)}function drainQueue(){runHandlers(handlerQueue),handlerQueue=[]}function identity(x){return x}when.promise=promise,when.resolve=resolve,when.reject=reject,when.defer=defer,when.join=join,when.all=all,when.map=map,when.reduce=reduce,when.settle=settle,when.any=any,when.some=some,when.isPromise=isPromiseLike,when.isPromiseLike=isPromiseLike,Promise.prototype={then:function(){var args,sendMessage;return args=arguments,sendMessage=this._message,_promise(function(resolve,reject,notify){sendMessage("when",args,resolve,notify)},this._status&&this._status.observed())},otherwise:function(onRejected){return this.then(undef,onRejected)},ensure:function(onFulfilledOrRejected){function injectHandler(){return resolve(onFulfilledOrRejected())}return"function"==typeof onFulfilledOrRejected?this.then(injectHandler,injectHandler).yield(this):this},yield:function(value){return this.then(function(){return value})},tap:function(onFulfilledSideEffect){return this.then(onFulfilledSideEffect).yield(this)},spread:function(onFulfilled){return this.then(function(array){return all(array,function(array){return onFulfilled.apply(undef,array)})})},always:function(onFulfilledOrRejected,onProgress){return this.then(onFulfilledOrRejected,onFulfilledOrRejected,onProgress)}},NearFulfilledProxy.prototype.when=function(onResult){return"function"==typeof onResult?onResult(this.value):this.value},NearRejectedProxy.prototype.when=function(_,onError){if("function"==typeof onError)return onError(this.reason);throw this.reason};var reduceArray,slice,fcall,nextTick,handlerQueue,setTimeout,funcProto,call,arrayProto,monitorApi,cjsRequire,MutationObserver,undef;if(cjsRequire=require,handlerQueue=[],setTimeout=global.setTimeout,monitorApi="undefined"!=typeof console?console:when,"object"==typeof process&&process.nextTick)nextTick=process.nextTick;else if(MutationObserver=global.MutationObserver||global.WebKitMutationObserver)nextTick=function(document,MutationObserver,drainQueue){var el=document.createElement("div");return new MutationObserver(drainQueue).observe(el,{attributes:!0}),function(){el.setAttribute("x","x")}}(document,MutationObserver,drainQueue);else try{nextTick=cjsRequire("vertx").runOnLoop||cjsRequire("vertx").runOnContext}catch(ignore){nextTick=function(t){setTimeout(t,0)}}return funcProto=Function.prototype,call=funcProto.call,fcall=funcProto.bind?call.bind(call):function(f,context){return f.apply(context,slice.call(arguments,2))},arrayProto=[],slice=arrayProto.slice,reduceArray=arrayProto.reduce||function(reduceFunc){var arr,args,reduced,len,i;if(i=0,arr=Object(this),len=arr.length>>>0,args=arguments,args.length<=1)for(;;){if(i in arr){reduced=arr[i++];break}if(++i>=len)throw new TypeError}else reduced=args[1];for(;len>i;++i)i in arr&&(reduced=reduceFunc(reduced,arr[i],i,arr));return reduced},when})}("function"==typeof define&&define.amd?define:function(factory){module.exports=factory(require)},this);